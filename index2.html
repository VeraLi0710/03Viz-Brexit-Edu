<!DOCTYPE html>  
<html lang="en">  
<head>  
  <meta charset="utf-8">  
  <title>2020/2021 Schools Data Visualization with Slider</title>  
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">  

  <!-- Mapbox GL JS -->  
  <script src="https://api.tiles.mapbox.com/mapbox-gl-js/v3.4.0/mapbox-gl.js"></script>  
  <link href="https://api.tiles.mapbox.com/mapbox-gl-js/v3.4.0/mapbox-gl.css" rel="stylesheet">  

  <!-- Turf.js -->  
  <script src="https://unpkg.com/@turf/turf@6/turf.min.js"></script>  

  <!-- Chart.js -->  
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>  

  <!-- Mapbox-gl-compare -->  
  <link href="./mapbox-gl-compare-main/dist/mapbox-gl-compare.css" rel="stylesheet">  
  <script src="./mapbox-gl-compare-main/dist/mapbox-gl-compare.js"></script>  

  <style>  
    body { margin: 0; padding: 0; }  
    .main-container {
      display: flex;
      width: 100%;
      height: 100vh;
    }
    .sidebar {
      width: 300px;
      background-color: #f8f9fa;
      padding: 20px;
      box-shadow: 2px 0 5px rgba(0,0,0,0.1);
      overflow-y: auto;
      z-index: 2;
    }
    #comparison-container {  
      position: relative;
      flex: 1;
      height: 100vh;
    }  
    .map {  
      position: absolute;  
      top: 0;  
      bottom: 0;  
      width: 100%;  
    }  
    .info-box {  
      position: fixed;  
      bottom: 20px;  
      right: 20px;  
      background: rgba(255, 255, 255, 0.9);  
      border-radius: 10px;  
      padding: 10px;  
      max-width: 2000px;  
      max-height: 400px;  
      overflow-y: auto;  
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.5);  
      z-index: 1000;  
      display: none;  
    }  
    #countryChart {  
      width: 100%;  
      height: 150px;   
    }
    .sidebar h2 {
      margin-bottom: 20px;
      color: #333;
    }
    .sidebar-section {
      margin-bottom: 25px;
      padding: 15px;
      background: white;
      border-radius: 8px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }
    .legend-item {
      display: flex;
      align-items: center;
      margin-bottom: 8px;
    }
    .legend-color {
      width: 20px;
      height: 20px;
      margin-right: 10px;
      border-radius: 4px;
    }
  </style>  
</head>  
<body>  

<div class="main-container">
  <div class="sidebar">
    <h2>Brexit Impact on International Students</h2>
    
    <div class="sidebar-section">
      <h3>About</h3>
      <p>This visualization compares international student distribution across UK universities before (2020) and after (2021) Brexit.</p>
    </div>

    <div class="sidebar-section">
      <h3>Legend</h3>
      <div class="legend-item">
        <div class="legend-color" style="background: #ffcccc"></div>
        <span>0-1000 students</span>
      </div>
      <div class="legend-item">
        <div class="legend-color" style="background: #ff6666"></div>
        <span>1000-3000 students</span>
      </div>
      <div class="legend-item">
        <div class="legend-color" style="background: #ff3333"></div>
        <span>3000-5000 students</span>
      </div>
      <div class="legend-item">
        <div class="legend-color" style="background: #cc0000"></div>
        <span>5000+ students</span>
      </div>
    </div>

    <div class="sidebar-section">
      <h3>Instructions</h3>
      <p>• Use the slider to compare 2020 and 2021 data</p>
      <p>• Click on hexagons to view detailed information</p>
      <p>• Hover over areas to highlight them</p>
    </div>
  </div>

  <div id="comparison-container">  
    <div id="map2020" class="map"></div>  
    <div id="map2021" class="map"></div>  
  </div>
</div>

<div class="info-box" id="infoBox">  
  <div id="infoContent"></div>  
  <canvas id="countryChart"></canvas>  
</div>  

<script>  
  // Mapbox Token  
  mapboxgl.accessToken = 'pk.eyJ1IjoieWl4aW5nLWxpIiwiYSI6ImNtN3FtNWh6YjA0ancybnM4aGxjZnlheTEifQ.sKwaoIMQR65VQmYDbnu2MQ';  

  const map2020 = new mapboxgl.Map({  
    container: 'map2020',  
    style: 'mapbox://styles/yixing-li/cm7qq3q0q00le01sb6zwp03g9',  
    center: [0, 51.5],  
    zoom: 5,  
    pitch: 45,  
    bearing: 0  
  });  

  const map2021 = new mapboxgl.Map({  
    container: 'map2021',  
    style: 'mapbox://styles/yixing-li/cm7qq3q0q00le01sb6zwp03g9',  
    center: [0, 51.5],  
    zoom: 5,  
    pitch: 45,  
    bearing: 0  
  });  

  new mapboxgl.Compare(map2020, map2021, '#comparison-container', {  
    orientation: 'vertical'  
  });  

  const processMapData = (map, geojsonUrl, is2021) => {  
    map.on('load', () => {  
      fetch(geojsonUrl)  
        .then(response => response.json())  
        .then(data => {  
          const filteredFeatures = data.features.filter(f => f.geometry?.type === "Point" && f.properties?.students > 0);  
          const filteredData = { type: 'FeatureCollection', features: filteredFeatures };  
          const bbox = turf.bbox(filteredData);  
          const cellSizeKm = 3;  
          let hexGrid = turf.hexGrid(bbox, cellSizeKm, { units: 'kilometers' });  

          hexGrid.features.forEach((hex) => {  
            let sumStudents = 0;  
            let countries = {};  
            let providerSet = new Set();  

            filteredData.features.forEach(pt => {  
              if (turf.booleanPointInPolygon(pt, hex)) {  
                sumStudents += pt.properties.students;  
                const c = pt.properties.country || 'unknown';  
                countries[c] = (countries[c] || 0) + pt.properties.students;  
                providerSet.add(pt.properties.he_provider || "Unnamed School");  
              }  
            });  

            const providerNameStr = Array.from(providerSet).map(name => "• " + name).join("<br/>");  

            hex.properties = {  
              sum_students: sumStudents,  
              countries: countries,  
              he_provider: providerNameStr  
            };  
          });  

          hexGrid.features = hexGrid.features.filter(f => f.properties.sum_students > 0);  
          map.addSource('schools-hex', { type: 'geojson', data: hexGrid });  

          // 2020年3D填充层  
          map.addLayer({  
            id: 'hex-extrusion-2020',  
            type: 'fill-extrusion',  
            source: 'schools-hex',  
            paint: {  
              'fill-extrusion-height': ['interpolate', ['linear'], ['zoom'], 3, ['*', ['get', 'sum_students'], 0.5], 5, ['*', ['get', 'sum_students'], 1], 8, ['*', ['get', 'sum_students'], 5], 10, ['*', ['get', 'sum_students'], 15], 15, ['*', ['get', 'sum_students'], 200], 20, ['*', ['get', 'sum_students'], 10000]],  
              'fill-extrusion-color': ['interpolate', ['linear'], ['get', 'sum_students'], 0, '#ffcccc', 1000, '#d2f2ff', 3000, '#c4eeff', 5000, '#a8e5ff', 7000, '#67abff', 10000, '#499bff'],  
              'fill-extrusion-opacity': 0.6 
            }  
          });  

          // 2021年3D填充层  
          map.addLayer({  
            id: 'hex-extrusion-2021',  
            type: 'fill-extrusion',  
            source: 'schools-hex',  
            paint: {  
              'fill-extrusion-height': ['interpolate', ['linear'], ['zoom'], 3, ['*', ['get', 'sum_students'], 0.5], 5, ['*', ['get', 'sum_students'], 1], 8, ['*', ['get', 'sum_students'], 5], 10, ['*', ['get', 'sum_students'], 15], 15, ['*', ['get', 'sum_students'], 200], 20, ['*', ['get', 'sum_students'], 10000]],  
              'fill-extrusion-color': ['interpolate', ['linear'], ['get', 'sum_students'], 0, '#ffcccc', 1000, '#ff9999', 3000, '#ff6666', 5000, '#ff3333', 7000, '#ff0000', 10000, '#cc0000'],  
              'fill-extrusion-opacity': 0.6  
            }  
          });  

          // 缩放到所有 hex 范围  
          const bounds = new mapboxgl.LngLatBounds();  
          hexGrid.features.forEach(f => {  
            f.geometry.coordinates[0].forEach(coord => {  
              bounds.extend(coord);  
            });  
          });  
          map.fitBounds(bounds, { padding: 50 });  

          // 鼠标事件  
          map.on('mousemove', ['hex-extrusion-2020', 'hex-extrusion-2021'], (e) => {  
            const feature = e.features[0];  
            if (!feature) return;  

            const layerId = feature.layer.id;  
            const is2020 = layerId === 'hex-extrusion-2020';  

            // 恢复其他柱子的颜色  
            map.setPaintProperty('hex-extrusion-2020', 'fill-extrusion-opacity', 0.8);  
            map.setPaintProperty('hex-extrusion-2021', 'fill-extrusion-opacity', 0.8);  
            
            // 高亮当前柱子  
            map.setPaintProperty(layerId, 'fill-extrusion-opacity', 1);  
            map.setPaintProperty(layerId, 'fill-extrusion-color', '#fff');  // 决定高亮颜色  

          });  

          // 点击事件显示信息框  
          map.on('click', ['hex-extrusion-2020', 'hex-extrusion-2021'], (e) => {  
            const feature = e.features[0];  
            if (!feature) return;  

            const props = feature.properties;  
            const totalStudents = props.sum_students;  
            const providerName = props.he_provider || "Unnamed School";  

            document.getElementById('infoContent').innerHTML = `  
              <strong>${feature.layer.id === 'hex-extrusion-2021' ? 'Post-Brexit (2021)' : 'Pre-Brexit (2020)'} International Students</strong><br>  
              ${providerName}<br>  
              Total International Students: <strong>${totalStudents}</strong>  
            `;  
            document.getElementById('infoBox').style.display = 'block';  

            // 更新图表  
            const ctx = document.getElementById('countryChart');  

            const countryData = [];  
            const countryLabels = [];  
            for (const country in props.countries) {  
              if (props.countries.hasOwnProperty(country)) {  
                countryLabels.push(country);  
                countryData.push(props.countries[country]);  
              }  
            }  

            // 清空之前的图表  
            if (Chart.getChart(ctx)) {  
              Chart.getChart(ctx).destroy();  
            }  

            new Chart(ctx, {  
              type: 'bar',  
              data: {  
                labels: countryLabels,  
                datasets: [{  
                  label: 'Students',  
                  data: countryData,  
                  backgroundColor: '#2c81c0',  
                  barPercentage: 0.8,  // 增大柱子宽度  
                  categoryPercentage: 0.8   
                }]  
              },  
              options: {  
                responsive: true,  
                maintainAspectRatio: false,  
                scales: {  
                  x: { ticks: { color: '#333' } },  
                  y: { beginAtZero: true, ticks: { color: '#333' } },  
                },   
                plugins: { legend: { display: false }, title: { display: false } }  
              }  
            });  
          });  

          // 鼠标离开时恢复颜色  
          map.on('mouseleave', ['hex-extrusion-2020', 'hex-extrusion-2021'], () => {  
            map.setPaintProperty('hex-extrusion-2020', 'fill-extrusion-opacity', 0.8);  
            map.setPaintProperty('hex-extrusion-2021', 'fill-extrusion-opacity', 0.8);  
          });  
        })  
        .catch(error => console.error("加载或处理 GeoJSON 时出错:", error));  
    });  
  };  

  // 加载两个数据文件  
  processMapData(map2020, './geojson_outputs_schools_2020_2021.geojson', false);  
  processMapData(map2021, './geojson_outputs_schools_2021_2022.geojson', true);  
</script>  

</body>  
</html>   