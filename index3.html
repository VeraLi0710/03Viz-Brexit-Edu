<!DOCTYPE html>  
<html lang="en">  
<head>  
    <meta charset="utf-8">  
    <title>2020/2021 Schools Data Visualization</title>  
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">  
    <!-- Mapbox GL JS -->  
    <script src="https://api.tiles.mapbox.com/mapbox-gl-js/v3.4.0/mapbox-gl.js"></script>  
    <link href="https://api.tiles.mapbox.com/mapbox-gl-js/v3.4.0/mapbox-gl.css" rel="stylesheet">  
    <!-- Turf.js -->  
    <script src="https://unpkg.com/@turf/turf@6/turf.min.js"></script>  
    <!-- Chart.js -->  
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>  
    <!-- Mapbox-gl-compare -->  
    <link href="./mapbox-gl-compare-main/dist/mapbox-gl-compare.css" rel="stylesheet">  
    <script src="./mapbox-gl-compare-main/dist/mapbox-gl-compare.js"></script>  
    <style>  
body {   
    margin: 0;   
    padding: 0;   
}  

#comparison-container {   
    position: relative;   
    height: 100vh;   
    width: 100%;   
}  

.map {   
    position: absolute;   
    top: 0;   
    bottom: 0;   
    width: 100%;   
}  

.info-box {  
    position: fixed;  
    bottom: 20px;  
    right: 20px;  
    background: rgba(255, 255, 255, 0.9); /* 外框透明度 */  
    border-radius: 10px;  
    padding: 0px;  
    width: 500px;  
    max-height: 300px;  
    overflow: hidden;   
    box-shadow: 0 1px 6px rgba(0, 0, 0, 0.5);  
    border: 0.1px solid rgba(0, 0, 0, 0.1);   
    color: #333;  
    font-size: 10px;   
    z-index: 1000;  
    display: none;  
}   

#infoContent {  
    padding: 10px;  
    height: calc(100% - 20px);  
    overflow-y: auto; /* 允许内容区域滚动 */  
}  

#countryChart {  
    width: 100%;  
    height: 150px; /* 调整高度 */  
}  

#searchContainer {  
    position: fixed;  
    top: 10px;   
    right: 20px;   
    z-index: 1001;   
}  

#searchBar {  
    width: 300px;   
    padding: 8px;  
    border-radius: 5px;  
    border: 1px solid #ccc;  
    font-size: 14px;   
}  

#searchButton {  
    background: none;  
    border: none;  
    cursor: pointer;  
    margin-left: -40px;   
}  

.highlight {
    circle-color: rgba(255, 0, 0, 0.6);   
    transition: 0.3s;  
}  

.tooltip {  
    position: fixed;  
    background: rgba(255, 255, 255, 0.9); /* 统一透明度 */  
    border-radius: 5px;  
    padding: 5px;  
    display: none;  
    z-index: 1001;  
    pointer-events: none;  
    border: 0.1px solid rgba(0, 0, 0, 0.1); /* 添加边框 */  
    box-shadow: 0 1px 6px rgba(0, 0, 0, 0.15); /* 添加阴影 */  
}  

.close-btn {  
    position: absolute;  
    top: 10px;   
    right: 10px;   
    background: none;  
    border: none;  
    cursor: pointer;  
    font-size: 20px;  
}  

.suggestions {  
    position: fixed;  
    top: 50px;  
    right: 20px;  
    background: rgba(255, 255, 255, 0.9); /* 统一透明度 */  
    border: 0.1px solid rgba(0, 0, 0, 0.1); /* 较细的边框 */  
    z-index: 1001;  
    max-height: 200px;  
    overflow-y: auto; /* 允许内容区域滚动 */  
    width: 300px;  
    display: none;  
    font-size: 10px; /* 确保搜索建议的字体大小一致 */  
}  

.suggestion-item {  
    padding: 10px;  
    cursor: pointer;  
    border-bottom: 1px solid #ccc;  
}  

.suggestion-item:hover {  
    background: #f0f0f0;   
}  

    }  
    </style>  
</head>  
<body>  
    <div id="searchContainer">  
        <div style="position: relative;">  
            <input type="text" id="searchBar" placeholder="Search Schools..." />  
            <button id="searchButton" style="position: absolute; right: 10px; top: 50%; transform: translateY(-50%);">  
                <img src="https://img.icons8.com/material-outlined/24/000000/search.png" alt="Search" />  
            </button>  
        </div>  
    </div>  
    <div class="suggestions" id="suggestions"></div>  
    <div id="comparison-container">  
        <div id="map2020" class="map"></div>  
        <div id="map2021" class="map"></div>  
    </div>  
    <div class="info-box" id="infoBox">  
        <button class="close-btn" onclick="document.getElementById('infoBox').style.display='none'">&times;</button>  
        <div id="infoContent"></div>  
        <canvas id="countryChart"></canvas>  
    </div>  
    <div class="tooltip" id="tooltip"></div>  
    <script>  
        // Mapbox Token  
        mapboxgl.accessToken = 'pk.eyJ1IjoieWl4aW5nLWxpIiwiYSI6ImNtN3FtNWh6YjA0ancybnM4aGxjZnlheTEifQ.sKwaoIMQR65VQmYDbnu2MQ';  
        const map2020 = new mapboxgl.Map({  
            container: 'map2020',  
            style: 'mapbox://styles/yixing-li/cm7qq3q0q00le01sb6zwp03g9',  
            center: [0, 51.5],  
            zoom: 5,  
            pitch: 0,  
            bearing: 0  
        });  
        const map2021 = new mapboxgl.Map({  
            container: 'map2021',  
            style: 'mapbox://styles/yixing-li/cm7qq3q0q00le01sb6zwp03g9',  
            center: [0, 51.5],  
            zoom: 5,  
            pitch: 0,  
            bearing: 0  
        });  
        new mapboxgl.Compare(map2020, map2021, '#comparison-container', {  
            orientation: 'vertical'  
        });  
        
        const processMapData = (map, geojsonUrl, heatmapColor, pointColor, yearLabel) => {  
            map.on('load', () => {  
                fetch(geojsonUrl)  
                    .then(response => response.json())  
                    .then(data => {  
                        const filteredFeatures = data.features.filter(f => f.geometry?.type === "Point" && f.properties?.students > 0);  
                        const filteredData = { type: 'FeatureCollection', features: filteredFeatures };  
                        // Add heatmap layer  
                        map.addSource('schools-heatmap', {  
                            type: 'geojson',  
                            data: filteredData  
                        });  
                        map.addLayer({  
                            id: 'schools-heatmap-layer',  
                            type: 'heatmap',  
                            source: 'schools-heatmap',  
                            paint: {  
                                'heatmap-weight': [  
                                    'interpolate',  
                                    ['linear'],  
                                    ['get', 'students'],  
                                    0, 0,  
                                    100, 0.05,  
                                    500, 0.1,  
                                    1000, 0.2,  
                                    5000, 0.4,  
                                    8000, 0.5,  
                                    10000, 0.6,  
                                    11000, 0.7,  
                                    13000, 0.85,  
                                    15000, 1  
                                ],  
                                'heatmap-color': [  
                                    'interpolate',  
                                    ['linear'],  
                                    ['heatmap-density'],  
                                    0, 'rgba(255,255,255,0)',  
                                    0.2, heatmapColor[0],  
                                    0.4, heatmapColor[1],  
                                    0.6, heatmapColor[2],  
                                    0.8, heatmapColor[3]  
                                ],  
                                'heatmap-radius': [  
                                    'interpolate',  
                                    ['linear'],  
                                    ['zoom'],  
                                    0, 20,  
                                    9, 40  
                                ],  
                                'heatmap-intensity': [  
                                    'interpolate',  
                                    ['linear'],  
                                    ['zoom'],  
                                    0, 0.6,  
                                    9, 1.2  
                                ]  
                            }  
                        });  
                        // Add school points layer  
                        map.addSource('schools-points', { type: 'geojson', data: filteredData });  
                        map.addLayer({  
                            id: 'schools-points-layer',  
                            type: 'circle',  
                            source: 'schools-points',  
                            paint: {  
                                'circle-radius': [  
                                    'interpolate',  
                                    ['linear'],  
                                    ['get', 'students'],  
                                    0, 0.2,  
                                    100, 0.5,  
                                    500, 1,  
                                    800, 1.3,  
                                    1000, 1.7,  
                                    3000, 3,  
                                    5000, 4,  
                                    7000, 6,  
                                    8000, 7,  
                                    10000, 8,  
                                    15000, 10,  
                                    17000, 13  
                                ],  
                                'circle-color': pointColor,  
                                'circle-opacity': 0.8,  
                                'circle-stroke-width': 0.5,  
                                'circle-stroke-color': '#FFFFFF'  
                            }  
                        });  
                        const bounds = new mapboxgl.LngLatBounds();  
                        filteredFeatures.forEach(f => {  
                            bounds.extend(f.geometry.coordinates);  
                        });  
                        map.fitBounds(bounds, { padding: 50 });  
                        // Click event  
                        map.on('click', 'schools-points-layer', (e) => {  
                            const feature = e.features[0];  
                            if (!feature) return;  
                            const props = feature.properties;  
                            const totalStudents = props.students;  
                            const providerName = props.he_provider || "Unnamed School";  
                            const countriesCount = {};  
                            filteredFeatures.forEach(f => {  
                                const country = f.properties.country;  
                                const students = f.properties.students;  
                                if (country && country.trim() !== "" && !country.toLowerCase().includes("total")) {  
                                    if (!countriesCount[country]) {  
                                        countriesCount[country] = 0;  
                                    }  
                                    countriesCount[country] += students;  
                                }  
                            });  
                            const countryLabels = Object.keys(countriesCount);  
                            const countryData = Object.values(countriesCount);  
                            const popupHTML = `  
                            <div style="background: rgba(255,255,255,0.6); padding: 10px; max-height: 300px; font-family: Arial, sans-serif; border-radius: 10px; box-shadow: 0 1px 6px rgba(0, 0, 0, 0.15); border: 0.1px solid rgba(0, 0, 0, 0.1); color: #333; font-size: 10px; overflow-y: auto;">  
                                <div style="font-weight: bold;">${providerName}</div>  
                                <div>Year: <strong>${yearLabel}</strong></div>  
                                <div>Total International Students: <strong>${totalStudents}</strong></div>  
                                <canvas id="countryChart" style="border: 1px solid #ccc; display: block; width: 100%; height: 150px;"></canvas>  
                            </div>  
                            `;  
                            document.getElementById('infoContent').innerHTML = popupHTML;  
                            document.getElementById('infoBox').style.display = 'block';  
                            const ctx = document.getElementById('countryChart');  
                            if (Chart.getChart(ctx)) {  
                                Chart.getChart(ctx).destroy();  
                            }  
                            setTimeout(() => {  
                                new Chart(ctx, {  
                                    type: 'bar',  
                                    data: {  
                                        labels: countryLabels,  
                                        datasets: [{  
                                            label: 'Students',  
                                            data: countryData,  
                                            backgroundColor: '#2c81c0',  
                                            barPercentage: 0.6,  
                                            categoryPercentage: 0.6  
                                        }]  
                                    },  
                                    options: {  
                                        responsive: true,  
                                        maintainAspectRatio: false,  
                                        scales: {  
                                            x: {  
                                                ticks: {  
                                                    color: '#333',  
                                                    font: { size: 10 }  
                                                }  
                                            },  
                                            y: {  
                                                beginAtZero: true,  
                                                ticks: {  
                                                    color: '#333',  
                                                    font: { size: 10 }  
                                                }  
                                            }  
                                        },  
                                        plugins: {  
                                            legend: { display: false },  
                                            title: { display: false }  
                                        }  
                                    }  
                                });  
                            }, 50);  
                        });  
                        map.on('mouseenter', 'schools-points-layer', (e) => {  
                            map.getCanvas().style.cursor = 'pointer';  
                            const feature = e.features[0];  
                            const tooltip = document.getElementById('tooltip');  
                            tooltip.style.display = 'block';  
                            tooltip.innerHTML = "Click to view student composition";  
                            tooltip.style.left = `${e.point.x}px`;  
                            tooltip.style.top = `${e.point.y}px`;  
                        });  
                        map.on('mouseleave', 'schools-points-layer', () => {  
                            map.getCanvas().style.cursor = '';  
                            const tooltip = document.getElementById('tooltip');  
                            tooltip.style.display = 'none';  
                        });  
                    })  
                    .catch(error => console.error("加载或处理 GeoJSON 时出错:", error));  
            });  
        };  
        
        // 处理搜索功能  
        document.getElementById('searchBar').addEventListener('input', function() {  
            const filter = this.value.trim().toLowerCase();  
            const features = map2020.getSource('schools-points')._data.features;  
            const matchedFeatures = features.filter(feature => {  
                const schoolName = feature.properties.he_provider || "";  
                return schoolName.toLowerCase().includes(filter);  
            });  
            const suggestions = document.getElementById('suggestions');  
            suggestions.innerHTML = "";  
            matchedFeatures.forEach(feature => {  
                const schoolName = feature.properties.he_provider || "";  
                const suggestionItem = document.createElement('div');  
                suggestionItem.className = "suggestion-item";  
                suggestionItem.innerText = schoolName;  
                suggestionItem.onclick = () => {  
                    showSchoolInfo(feature, map2020);  
                };  
                suggestions.appendChild(suggestionItem);  
            });  
            suggestions.style.display = matchedFeatures.length > 0 ? 'block' : 'none';  
        });  

        const showSchoolInfo = (feature, map) => {  
            const props = feature.properties;  
            const totalStudents = props.students;  
            const providerName = props.he_provider || "Unnamed School";  
            const yearLabel = "2020/2021 (Pre-Brexit)";  
            const countriesCount = {};  
            const filteredFeatures = map.getSource('schools-points')._data.features;  
            filteredFeatures.forEach(f => {  
                const country = f.properties.country;  
                const students = f.properties.students;  
                if (country && country.trim() !== "" && !country.toLowerCase().includes("total")) {  
                    if (!countriesCount[country]) {  
                        countriesCount[country] = 0;  
                    }  
                    countriesCount[country] += students;  
                }  
            });  
            const countryLabels = Object.keys(countriesCount);  
            const countryData = Object.values(countriesCount);  
            const popupHTML = `  
            <div style="max-height: 300px; overflow-y: auto;">  
                <div style="font-weight: bold;">${providerName}</div>  
                <div>Year: <strong>${yearLabel}</strong></div>  
                <div>Total International Students: <strong>${totalStudents}</strong></div>  
                <canvas id="countryChart" style="border: 1px solid #ccc; display: block; width: 100%; height: 150px;"></canvas>  
            </div>  
            `;  
            document.getElementById('infoContent').innerHTML = popupHTML;  
            document.getElementById('infoBox').style.display = 'block';  
            const ctx = document.getElementById('countryChart');  
            if (Chart.getChart(ctx)) {  
                Chart.getChart(ctx).destroy();  
            }  
            setTimeout(() => {  
                new Chart(ctx, {  
                    type: 'bar',  
                    data: {  
                        labels: countryLabels,  
                        datasets: [{  
                            label: 'Students',  
                            data: countryData,  
                            backgroundColor: '#2c81c0',  
                            barPercentage: 0.6,  
                            categoryPercentage: 0.6  
                        }]  
                    },  
                    options: {  
                        responsive: true,  
                        maintainAspectRatio: false,  
                        scales: {  
                            x: {  
                                ticks: {  
                                    color: '#333',  
                                    font: { size: 10 }  
                                }  
                            },  
                            y: {  
                                beginAtZero: true,  
                                ticks: {  
                                    color: '#333',  
                                    font: { size: 10 }  
                                }  
                            }  
                        },  
                        plugins: {  
                            legend: { display: false },  
                            title: { display: false }  
                        }  
                    }  
                });  
            }, 50);  
            const coordinates = feature.geometry.coordinates;  
            map.flyTo({ center: coordinates, zoom: 10 });  
        };  
        
        // Load data files  
        processMapData(map2020, './geojson_outputs_schools_2020_2021.geojson', [  
            'rgba(200,200,255,0.5)',  
            'rgba(150, 173, 255, 0.72)',  
            'rgba(111, 133, 231, 0.85)',  
            'rgb(87, 95, 221)'  
        ], '#FFFFFF', '2020/2021 (Pre-Brexit)');  
        processMapData(map2021, './geojson_outputs_schools_2021_2022.geojson', [  
            'rgba(255,200,200,0.5)',  
            'rgba(255,150,150,0.7)',  
            'rgba(255, 114, 114, 0.9)',  
            'rgb(247, 77, 77)'  
        ], '#FFFFFF', '2021/2022 (Post-Brexit)');  
    </script>  
</body>  
</html>  