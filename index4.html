<!DOCTYPE html>  
<html lang="en">  
<head>  
    <meta charset="utf-8">  
    <title>2020/2021 Schools Data Visualization</title>  
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">  
    <!-- Mapbox GL JS -->  
    <script src="https://api.tiles.mapbox.com/mapbox-gl-js/v3.4.0/mapbox-gl.js"></script>  
    <link href="https://api.tiles.mapbox.com/mapbox-gl-js/v3.4.0/mapbox-gl.css" rel="stylesheet">  
    <!-- Turf.js -->  
    <script src="https://unpkg.com/@turf/turf@6/turf.min.js"></script>  
    <!-- Chart.js -->  
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>  
    <!-- Mapbox-gl-compare -->  
    <link href="./mapbox-gl-compare-main/dist/mapbox-gl-compare.css" rel="stylesheet">  
    <script src="./mapbox-gl-compare-main/dist/mapbox-gl-compare.js"></script>  
    <style>  
body {   
    margin: 0;   
    padding: 0;
    overflow: hidden
}  

#comparison-container {   
    position: relative;   
    height: 100vh;   
    width: 100%;   
}  

.map {   
    position: absolute;   
    top: 0;   
    bottom: 0;   
    width: 100%;   
}  

.info-box {  
    position: fixed;  
    bottom: 20px;  
    right: 20px;  
    background: rgba(255, 255, 255, 0.75); /* 外框透明度 */  
    border-radius: 10px;  
    padding: 0px;  
    width: 500px;  
    max-height: 300px;  
    overflow: hidden;   
    box-shadow: 0 1px 6px rgba(0, 0, 0, 0.5);  
    border: 0.1px solid rgba(0, 0, 0, 0.1);   
    color: #333;  
    font-size: 10px;   
    z-index: 1000;  
    display: none;  
}   

#infoContent {  
    padding: 10px;  
    height: calc(100% - 20px);  
    overflow-y: auto; /* 允许内容区域滚动 */  
}  

#countryChart {  
    width: 100%;  
    height: 150px; /* 调整高度 */  
}  

#searchContainer {  
    position: fixed;  
    top: 10px;   
    right: 20px;   
    z-index: 1001;   
}  

#searchBar {  
    width: 300px;   
    padding: 8px;  
    border-radius: 5px;  
    border: 1px solid #ccc;  
    font-size: 14px;   
}  

#searchButton {  
    background: none;  
    border: none;  
    cursor: pointer;  
    margin-left: -40px;   
}  

.highlight {
    circle-color: rgba(255, 0, 0, 0.6);   
    transition: 0.3s;  
}  

.tooltip {  
    position: fixed;  
    background: rgba(255, 255, 255, 0.8); /* 统一透明度 */  
    border-radius: 0px;  
    padding: 2px;  
    font-size: 4px
    display: none;  
    z-index: 1001;  
    pointer-events: none;  
    border: 0.1px solid rgba(0, 0, 0, 0.1); /* 添加边框 */  
    box-shadow: 0 1px 6px rgba(0, 0, 0, 0.15); /* 添加阴影 */  
}  

.close-btn {  
    position: absolute;  
    top: 10px;   
    right: 10px;   
    background: none;  
    border: none;  
    cursor: pointer;  
    font-size: 20px;  
}  

.suggestions {  
    position: fixed;  
    top: 50px;  
    right: 20px;  
    background: rgba(255, 255, 255, 0.9); /* 统一透明度 */  
    border: 0.1px solid rgba(0, 0, 0, 0.1); /* 较细的边框 */  
    z-index: 1001;  
    max-height: 200px;  
    overflow-y: auto; /* 允许内容区域滚动 */  
    width: 300px;  
    display: none;  
    font-size: 10px; /* 确保搜索建议的字体大小一致 */  
}  

.suggestion-item {  
    padding: 10px;  
    cursor: pointer;  
    border-bottom: 1px solid #ccc;  
}  

.suggestion-item:hover {  
    background: #f0f0f0;   
}  

        
#sidebar {  
    position: absolute;  
    top: 0;  
    left: 0;  
    width: 270px; /* 可以调整 */  
    height: 100%;  
    background-color: rgba(255, 255, 255, 0.7); /* 半透明白色背景 */  
    padding: 20px; /* 内边距 */  
    box-shadow: 2px 0 5px rgba(0, 0, 0, 0.5); /* 阴影效果 */  
}  

#progress-container {  
    display: flex;  
    justify-content: center; /* 改为居中 */  
    margin-bottom: 20px;   
}  

.dot {  
    width: 10px;   
    height: 10px;   
    border-radius: 50%;   
    background-color: #ccc; /* 默认颜色 */  
    margin: 0 3px; /* 适当的边距，防止紧挨在一起 */  
    cursor: pointer; /* 鼠标指针变为手形 */  
}  

.dot.active {  
    background-color: #52a7ff; /* 激活状态颜色 */  
}  

#next-button {  
    width: 100%;  
    padding: 8px;  
    background-color: #246ab4; /* 按钮颜色 */  
    color: white; 
    border: none;  
    border-radius: 5px; /* 圆角 */  
    cursor: pointer; /* 鼠标指针变为手形 */  
}  

#next-button:hover {  
    background-color: #6ba3df; /* 按钮悬停效果 */  
}  
    }  
    </style>  
</head>  
<body>  
    <div id="searchContainer">  
        <div style="position: relative;">  
            <input type="text" id="searchBar" placeholder="Search Schools..." />  
            <button id="searchButton" style="position: absolute; right: 10px; top: 50%; transform: translateY(-50%);">  
                <img src="https://img.icons8.com/material-outlined/24/000000/search.png" alt="Search" />  
            </button>  
        </div>  
    </div>  
    <div class="suggestions" id="suggestions"></div>  
    <div id="comparison-container">  
        <div id="map2020" class="map"></div>  
        <div id="map2021" class="map"></div>  
    </div>  
    <div class="info-box" id="infoBox">  
        <button class="close-btn" onclick="document.getElementById('infoBox').style.display='none'">&times;</button>  
        <div id="infoContent"></div>  
        <canvas id="countryChart"></canvas>  
    </div>  
    <div class="tooltip" id="tooltip"></div>
    
<div id="sidebar">  
    <div id="progress-container">  
        <div class="dot active" id="dot-1" data-zoom="default" onclick="navigateToView('default')"></div>  
        <div class="dot" id="dot-2" data-zoom="zoomIn" onclick="navigateToView('zoomIn')"></div>  
    </div>  
    <button id="next-button">Next</button>  
</div>  
    
    <script>  
        // Mapbox Token  
        mapboxgl.accessToken = 'pk.eyJ1IjoieWl4aW5nLWxpIiwiYSI6ImNtN3FtNWh6YjA0ancybnM4aGxjZnlheTEifQ.sKwaoIMQR65VQmYDbnu2MQ';  
        const map2020 = new mapboxgl.Map({  
            container: 'map2020',  
            style: 'mapbox://styles/yixing-li/cm7qq3q0q00le01sb6zwp03g9',  
            center: [-1, 40],  
            zoom: 3,  
            pitch: 0,  
            bearing: 0  
        });  
        const map2021 = new mapboxgl.Map({  
            container: 'map2021',  
            style: 'mapbox://styles/yixing-li/cm7qq3q0q00le01sb6zwp03g9',  
            center: [-1, 40],  
            zoom: 3,  
            pitch: 0,  
            bearing: 0  
        });  
        new mapboxgl.Compare(map2020, map2021, '#comparison-container', {  
            orientation: 'vertical'  
        });  
        
const processMapData = (map, geojsonUrl, heatmapColor, pointColor, yearLabel) => {  
    map.on('load', () => {  
        // 加载学校数据  
        fetch(geojsonUrl)  
            .then(response => response.json())  
            .then(data => {  
                const filteredFeatures = data.features.filter(f => f.geometry?.type === "Point" && f.properties?.students > 0);  
                const filteredData = { type: 'FeatureCollection', features: filteredFeatures };  

                // 加载国家质心数据  
                loadCountryCentroids(map, filteredFeatures);  

                // 添加热力图和学校点图层  
                addHeatmapLayer(map, filteredData, heatmapColor);  
                addSchoolsPointLayer(map, filteredData, pointColor);  

                // 确保图层加载完成后绑定事件  
                setupMapInteractions(map, filteredFeatures, yearLabel);  
            })  
            .catch(error => console.error("加载学校数据时出错:", error));  
    });  
};  


        
const processBrexitData = (map, geojsonUrlBefore, geojsonUrlAfter, heatmapColor, pointColor, yearLabel) => {  
    map.on('load', () => {  
        // 加载脱欧前学校数据  
        fetch(geojsonUrlBefore)  
            .then(response => response.json())  
            .then(dataBefore => {  
                const filteredFeaturesBefore = dataBefore.features.filter(f => f.geometry?.type === "Point" && f.properties?.students > 0);  
                
                // 加载脱欧后学校数据  
                fetch(geojsonUrlAfter)  
                    .then(response => response.json())  
                    .then(dataAfter => {  
                        const filteredFeaturesAfter = dataAfter.features.filter(f => f.geometry?.type === "Point" && f.properties?.students > 0);  
                        
                        // 合并两个数据  
                        const allFeatures = [...filteredFeaturesBefore, ...filteredFeaturesAfter];  

                        // 加载国家质心数据  
                        loadCountryCentroids(map, allFeatures, dataBefore, dataAfter);  

                        // 添加热力图和学校点图层  
                        addHeatmapLayer(map, allFeatures, heatmapColor);  
                        addSchoolsPointLayer(map, allFeatures, pointColor);  
                    })  
                    .catch(error => console.error("加载脱欧后学校数据时出错:", error));  
            })  
            .catch(error => console.error("加载脱欧前学校数据时出错:", error));  
    });  
};  

const formatCountryName = (name) => {  
    return name  
        .replace(/_/g, ' ') // Replace underscores with spaces  
        .split(' ') // Split into words  
        .map(word => word.charAt(0).toUpperCase() + word.slice(1).toLowerCase())  
        .join(' ');  
};  

// Function to load country centroids after map initialization  
const loadCountryCentroids = (map, allFeatures, dataBefore, dataAfter) => {  
    fetch('./countries_centroids.geojson')  
        .then(response => response.json())  
        .then(data => {  
            const countryCentroids = {};  
            // Iterate through features to construct country centroids  
            data.features.forEach(feature => {  
                const country = feature.properties.country;  
                countryCentroids[country] = feature;  
            });  

            // Draw flow lines on the map  
            drawFlowLines(map, countryCentroids, allFeatures);  

            // Add countries centroids source to the map  
            map.addSource('countries-centroids', {  
                type: 'geojson',  
                data: data  
            });  

            // Add country centroid points layer to the map  
            map.addLayer({  
                id: 'country-centroids-layer',  
                type: 'circle',  
                source: 'countries-centroids',  
                paint: {  
                    'circle-radius': 3,  
                    'circle-color': '#000000',  
                    'circle-opacity': 0.6  
                }  
            });  

            // Add country name labels layer to the map  
            map.addLayer({  
                id: 'country-labels-layer',  
                type: 'symbol',  
                source: 'countries-centroids',  
                layout: {  
                    'text-field': ['get', 'country'],  
                    'text-font': ['Open Sans Bold', 'Arial Unicode MS Bold'],  
                    'text-size': 12,  
                    'text-allow-overlap': true  
                },  
                paint: {  
                    'text-color': '#FFFFFF'  
                }  
            });  
        })  
        .catch(error => console.error("Loading countries_centroids data failed:", error));  
};  

const dots = document.querySelectorAll('.dot');  
let currentIndex = 0; // Current active index  
const firstView = {  
    center: [-1, 40], // Initial coordinates  
    zoom: 3,          // Initial zoom level  
};  

// Function to navigate to a view based on the dot clicked  
function navigateToView(view) {  
    // Update currentIndex based on the view selected  
    if (view === 'default') {  
        currentIndex = 0;  
    } else if (view === 'zoomIn') {  
        currentIndex = 1;  
    }  
    // Update the active dots  
    updateDots();  
    handleMapZoom(); // Call to adjust the map view  
}  

// Function to update the active state of the dots  
function updateDots() {  
    dots.forEach((dot, index) => {  
        dot.classList.toggle('active', index === currentIndex); // Toggle activation based on index  
    });  
}  

// Function to adjust the map view based on currentIndex  
function handleMapZoom() {  
    if (currentIndex === 0) {  
        // Reset to the first view settings  
        map2020.flyTo({  
            center: firstView.center,  
            zoom: firstView.zoom,  
            speed: 1,  
            curve: 1,  
            easing(t) { return t; }  
        });  
    } else if (currentIndex === 1) {  
        // Coordinates for zoomed-in view  
        map2020.flyTo({  
            center: [-2.2, 53], // Example coordinates for zoomed-in  
            zoom: 5.8, // Zoom level for zoomed-in view  
            speed: 1,  
            curve: 1,  
            easing(t) { return t; }  
        });  
    }  
}  

// Handle the "Next" button click event  
document.getElementById('next-button').addEventListener('click', function() {  
    // Toggle between views  
    if (currentIndex < 1) { // Assuming there are two views  
        currentIndex++; // Move to the next view  
    } else {  
        currentIndex = 0; // Go back to the first view  
    }  
    updateDots(); // Update dot states  
    handleMapZoom(); // Adjust the map view  
});  

// Adding event listeners to dots for user interaction  
dots.forEach(dot => {  
    dot.addEventListener('click', () => {  
        navigateToView(dot.getAttribute('data-zoom')); // Navigate based on dot data-zoom  
    });  
});  
        
    
// 修改 drawFlowLines 函数，使其区分颜色  
const drawFlowLines = (map, countryCentroids, allFeatures) => {  
    const studentsFlowData = { type: 'FeatureCollection', features: [] };  

    allFeatures.forEach(feature => {  
        const props = feature.properties;  
        const totalStudents = props.students;  
        const country = props.country;  
        const centroidFeature = countryCentroids[country];  

        if (centroidFeature) {  
            const startCoord = feature.geometry.coordinates;  
            const endCoord = centroidFeature.geometry.coordinates;  

            // 中间点以制造抛物线效果  
            const midPoint = [  
                (startCoord[0] + endCoord[0]) / 2,  
                (startCoord[1] + endCoord[1]) / 2 + 0.3  
            ];  

            const flowLine = {  
                type: 'Feature',  
                geometry: {  
                    type: 'LineString',  
                    coordinates: [startCoord, midPoint, endCoord]  
                },  
                properties: {   
                    weight: totalStudents,   
                    brexitStatus: props.year // 假设 year 指示脱欧前后  
                }  
            };  
            studentsFlowData.features.push(flowLine);  
        }  
    });  

    if (studentsFlowData.features.length > 0) {  
        map.addSource('flow-lines', {  
            type: 'geojson',  
            data: studentsFlowData  
        });  

        map.addLayer({  
            id: 'flow-lines-layer',  
            type: 'line',  
            source: 'flow-lines',  
            paint: {  
                'line-width': [  
                    'interpolate',  
                    ['linear'],  
                    ['get', 'weight'],  
                    0, 0.1,  
                    100, 0.2,  
                    500, 0.5,  
                    1000, 1,  
                    5000, 2,  
                    10000, 3  
                ],  
                'line-opacity': [  
                    'interpolate',  
                    ['linear'],  
                    ['get', 'weight'],  
                    0, 0.1,  
                    100, 0.4,  
                    500, 0.6,  
                    1000, 0.8  
                ],  
                'line-color': [  
                    'case',  
                    ['==', ['get', 'brexitStatus'], '2020/2021'], 'rgba(210, 210, 255, 0.5)',  // 脱欧前  
                    ['==', ['get', 'brexitStatus'], '2021/2022'], 'rgba(255, 224, 224, 0.5)',  // 脱欧后  
                    'rgba(255, 255, 255, 0.5)'  // 默认颜色  
                ]  
            }  
        });  
    } else {  
        console.warn("没有流动数据可用");  
    }  
};  
// 继续定义其余功能...  

// 添加热力图图层  
const addHeatmapLayer = (map, filteredData, heatmapColor) => {  
    map.addSource('schools-heatmap', {  
        type: 'geojson',  
        data: filteredData  
    });  
    map.addLayer({  
        id: 'schools-heatmap-layer',  
        type: 'heatmap',  
        source: 'schools-heatmap',  
        paint: {  
            'heatmap-weight': [  
                'interpolate',  
                ['linear'],  
                ['get', 'students'],  
                0, 0,  
                100, 0.05,  
                500, 0.1,  
                1000, 0.2,  
                5000, 0.4,  
                8000, 0.5,  
                10000, 0.6,  
                11000, 0.7,  
                13000, 0.85,  
                15000, 1  
            ],  
            'heatmap-color': [  
                'interpolate',  
                ['linear'],  
                ['heatmap-density'],  
                0, 'rgba(255,255,255,0)',  
                0.2, heatmapColor[0],  
                0.4, heatmapColor[1],  
                0.6, heatmapColor[2],  
                0.8, heatmapColor[3]  
            ],  
            'heatmap-radius': [  
                'interpolate',  
                ['linear'],  
                ['zoom'],  
                0, 20,  
                9, 30  
            ],  
            'heatmap-intensity': [  
                'interpolate',  
                ['linear'],  
                ['zoom'],  
                0, 0.6,  
                9, 1.2  
            ]  
        }  
    });  
};  

// 添加学校点图层  
const addSchoolsPointLayer = (map, filteredData, pointColor) => {  
    map.addSource('schools-points', { type: 'geojson', data: filteredData });  
    map.addLayer({  
        id: 'schools-points-layer',  
        type: 'circle',  
        source: 'schools-points',  
        paint: {  
            'circle-radius': [  
                'interpolate',  
                ['linear'],  
                ['get', 'students'],  
                0, 0.2,  
                100, 0.5,  
                500, 1,  
                800, 1.3,  
                1000, 1.7,  
                3000, 3,  
                5000, 4,  
                7000, 6,  
                8000, 7,  
                10000, 8,  
                15000, 10,  
                17000, 13  
            ],  
            'circle-color': pointColor,  
            'circle-opacity': 0.8,  
            'circle-stroke-width': 0.5,  
            'circle-stroke-color': '#FFFFFF'  
        }  
    });  
};  

// 适应地图边界   
const fitMapToBounds = (map, filteredFeatures) => {  
    const bounds = new mapboxgl.LngLatBounds();  
    filteredFeatures.forEach(f => {  
        bounds.extend(f.geometry.coordinates);  
    });  
    map.fitBounds(bounds, { padding: 50 });  
};  

// 设置点击和鼠标事件   
const setupMapInteractions = (map, filteredFeatures, yearLabel) => {  
    map.on('click', 'schools-points-layer', (e) => {  
        const feature = e.features[0];  
        if (!feature) return;  

        const props = feature.properties;  
        const totalStudents = props.students;  
        const providerName = props.he_provider || "Unnamed School";  
        const countriesCount = getCountriesCount(filteredFeatures);  
        const countryLabels = Object.keys(countriesCount);  
        const countryData = Object.values(countriesCount);  

        // 根据年份判断颜色  
        const color = yearLabel.includes('2020') ? '#2c81c0' : '#e26363'; // 蓝色或红色  
        showPopup(providerName, yearLabel, totalStudents, countryLabels, countryData, color);  
    });  

    // 鼠标悬停效果保持不变  
    map.on('mouseenter', 'schools-points-layer', (e) => {  
        map.getCanvas().style.cursor = 'pointer';  
        displayTooltip(e.point, "Click to view student composition");  
    });  

    map.on('mouseleave', 'schools-points-layer', () => {  
        map.getCanvas().style.cursor = '';  
        hideTooltip();  
    });  
};  

// 显示弹窗内容   
const showPopup = (providerName, yearLabel, totalStudents, countryLabels, countryData, color) => {  
    const popupHTML = `  
        <div style="background: rgba(255,255,255,0.35); padding: 10px; max-height: 300px; font-family: Arial, sans-serif; border-radius: 10px; box-shadow: 0 1px 6px rgba(0, 0, 0, 0.15); color: #333; font-size: 10px; overflow-y: auto;">  
            <div style="font-weight: bold; font-size: 16px;">${providerName}</div> <!-- 增加字体大小 -->  
            <div>Year: <strong>${yearLabel}</strong></div>  
            <div>Total International Students: <strong>${totalStudents}</strong></div>  
            <canvas id="countryChart" style="border: 1px solid #ccc; display: block; width: 100%; height: 150px;"></canvas>  
        </div>  
    `;  

    document.getElementById('infoContent').innerHTML = popupHTML;  
    document.getElementById('infoBox').style.display = 'block';  

    // 更新图表  
    updateChart(countryLabels, countryData, color);  
};  

// 更新显示图表  
const updateChart = (countryLabels, countryData, color) => {  
    const ctx = document.getElementById('countryChart');  

    // 如果已有图表实例，先销毁  
    if (Chart.getChart(ctx)) {  
        Chart.getChart(ctx).destroy();  
    }  

    // 创建新的图表实例  
    new Chart(ctx, {  
        type: 'bar',  
        data: {  
            labels: countryLabels,  
            datasets: [{  
                label: 'Students',  
                data: countryData,  
                backgroundColor: color, // 动态设置颜色  
                barPercentage: 0.6,  
                categoryPercentage: 0.6  
            }]  
        },  
        options: {  
            responsive: true,  
            maintainAspectRatio: false,  
            scales: {  
                x: {  
                    ticks: {  
                        color: '#333',  
                        font: { size: 10 }  
                    }  
                },  
                y: {  
                    beginAtZero: true,  
                    ticks: {  
                        color: '#333',  
                        font: { size: 10 }  
                    }  
                }  
            },  
            plugins: {  
                legend: { display: false },  
                title: { display: false }  
            }  
        }  
    });  
};  

// 显示提示工具   
const displayTooltip = (point, message) => {  
    const tooltip = document.getElementById('tooltip');  
    tooltip.style.display = 'block';  
    tooltip.innerHTML = message;  
    tooltip.style.left = `${point.x}px`;  
    tooltip.style.top = `${point.y}px`;  
};  

// 隐藏提示工具  
const hideTooltip = () => {  
    const tooltip = document.getElementById('tooltip');  
    tooltip.style.display = 'none';  
};  

// 获取国家学生数量  
const getCountriesCount = (filteredFeatures) => {  
    const countriesCount = {};  
    filteredFeatures.forEach(f => {  
        const country = f.properties.country;  
        const students = f.properties.students;  
        if (country && country.trim() !== "" && !country.toLowerCase().includes("total")) {  
            countriesCount[country] = (countriesCount[country] || 0) + students;  
        }  
    });  
    return countriesCount;  
};   
        
        // 处理搜索功能  
        document.getElementById('searchBar').addEventListener('input', function() {  
            const filter = this.value.trim().toLowerCase();  
            const features = map2020.getSource('schools-points')._data.features;  
            const matchedFeatures = features.filter(feature => {  
                const schoolName = feature.properties.he_provider || "";  
                return schoolName.toLowerCase().includes(filter);  
            });  
            const suggestions = document.getElementById('suggestions');  
            suggestions.innerHTML = "";  
            matchedFeatures.forEach(feature => {  
                const schoolName = feature.properties.he_provider || "";  
                const suggestionItem = document.createElement('div');  
                suggestionItem.className = "suggestion-item";  
                suggestionItem.innerText = schoolName;  
                suggestionItem.onclick = () => {  
                    showSchoolInfo(feature, map2020);  
                };  
                suggestions.appendChild(suggestionItem);  
            });  
            suggestions.style.display = matchedFeatures.length > 0 ? 'block' : 'none';  
        });  

        const showSchoolInfo = (feature, map) => {  
            const props = feature.properties;  
            const totalStudents = props.students;  
            const providerName = props.he_provider || "Unnamed School";  
            const yearLabel = "2020/2021 (Pre-Brexit)";  
            const countriesCount = {};  
            const filteredFeatures = map.getSource('schools-points')._data.features;  
            filteredFeatures.forEach(f => {  
                const country = f.properties.country;  
                const students = f.properties.students;  
                if (country && country.trim() !== "" && !country.toLowerCase().includes("total")) {  
                    if (!countriesCount[country]) {  
                        countriesCount[country] = 0;  
                    }  
                    countriesCount[country] += students;  
                }  
            });  
            const countryLabels = Object.keys(countriesCount);  
            const countryData = Object.values(countriesCount);  
            const popupHTML = `  
            <div style="max-height: 300px; overflow-y: auto;">  
                <div style="font-weight: bold;">${providerName}</div>  
                <div>Year: <strong>${yearLabel}</strong></div>  
                <div>Total International Students: <strong>${totalStudents}</strong></div>  
                <canvas id="countryChart" style="border: 1px solid #ccc; display: block; width: 100%; height: 150px;"></canvas>  
            </div>  
            `;  
            document.getElementById('infoContent').innerHTML = popupHTML;  
            document.getElementById('infoBox').style.display = 'block';  
            const ctx = document.getElementById('countryChart');  
            if (Chart.getChart(ctx)) {  
                Chart.getChart(ctx).destroy();  
            }  
            setTimeout(() => {  
                new Chart(ctx, {  
                    type: 'bar',  
                    data: {  
                        labels: countryLabels,  
                        datasets: [{  
                            label: 'Students',  
                            data: countryData,  
                            backgroundColor: '#2c81c0',  
                            barPercentage: 0.6,  
                            categoryPercentage: 0.6  
                        }]  
                    },  
                    options: {  
                        responsive: true,  
                        maintainAspectRatio: false,  
                        scales: {  
                            x: {  
                                ticks: {  
                                    color: '#333',  
                                    font: { size: 10 }  
                                }  
                            },  
                            y: {  
                                beginAtZero: true,  
                                ticks: {  
                                    color: '#333',  
                                    font: { size: 10 }  
                                }  
                            }  
                        },  
                        plugins: {  
                            legend: { display: false },  
                            title: { display: false }  
                        }  
                    }  
                });  
            }, 50);  
            const coordinates = feature.geometry.coordinates;  
            map.flyTo({ center: coordinates, zoom: 10 });  
        };  
        
        // Load data files  
        processMapData(map2020, './geojson_outputs_schools_2020_2021.geojson', [  
            'rgba(200,200,255,0.5)',  
            'rgba(150, 173, 255, 0.72)',  
            'rgba(111, 133, 231, 0.85)',  
            'rgb(87, 95, 221)'  
        ], '#FFFFFF', '2020/2021 (Pre-Brexit)');  
        processMapData(map2021, './geojson_outputs_schools_2021_2022.geojson', [  
            'rgba(255,200,200,0.5)',  
            'rgba(255,150,150,0.7)',  
            'rgba(255, 114, 114, 0.9)',  
            'rgb(247, 77, 77)'  
        ], '#FFFFFF', '2021/2022 (Post-Brexit)');  
    </script>  
</body>  
</html>  