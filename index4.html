<!DOCTYPE html>  
<html lang="en">  
<head>  
    <meta charset="utf-8">  
    <title>Brexit Impact on UK International Students (2020-2022)</title>  
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">  
    
    <!-- External Dependencies -->  
    <script src="https://api.tiles.mapbox.com/mapbox-gl-js/v3.4.0/mapbox-gl.js"></script>  
    <link href="https://api.tiles.mapbox.com/mapbox-gl-js/v3.4.0/mapbox-gl.css" rel="stylesheet">  
    <script src="https://unpkg.com/@turf/turf@6/turf.min.js"></script>  
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>  
    <link href="./mapbox-gl-compare-main/dist/mapbox-gl-compare.css" rel="stylesheet">  
    <script src="./mapbox-gl-compare-main/dist/mapbox-gl-compare.js"></script>  

    <style>  
    /* Base Layout Styles */
    body {   
        margin: 0;   
        padding: 0;
        overflow: hidden;
    }  

    /* Map Container Styles */
    #comparison-container {   
        position: relative;   
        height: 100vh;   
        width: 100%;   
    }  

    .map {   
        position: absolute;   
        top: 0;   
        bottom: 0;   
        width: 100%;   
    }  

    /* Info Box Styles */
    .info-box {  
        position: fixed;  
        bottom: 20px;  
        right: 20px;  
        background: rgba(255, 255, 255, 0.75);
        border-radius: 8px;  
        padding: 10px;  
        width: 420px;  
        max-height: 280px;  
        overflow: hidden;   
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);  
        border: 1px solid rgba(0, 0, 0, 0.1);   
        color: #333;  
        font-size: 12px;   
        z-index: 1000;  
        display: none;  
        backdrop-filter: blur(5px);
        transition: all 0.3s ease;
    }   

    #infoContent {  
        height: calc(100% - 10px);  
        overflow-y: auto;
    }  

    /* Info Header Styles */
    .info-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 8px;
        padding-bottom: 6px;
        border-bottom: 1px solid rgba(0, 0, 0, 0.1);
    }

    .info-title {
        font-size: 16px;
        font-weight: bold;
        color: #246ab4;
    }

    /* Control Button Styles */
    .info-controls {
        display: flex;
        gap: 10px;
        align-items: center;
    }

    .brexit-toggle {
        padding: 6px 12px;
        border: 1px solid #ddd;
        border-radius: 4px;
        background: #fff;
        cursor: pointer;
        font-size: 11px;
        transition: all 0.2s ease;
    }

    .brexit-toggle.active {
        background: #246ab4;
        color: white;
        border-color: #246ab4;
    }

    /* Close Button Styles */
    .close-btn {  
        background: none;  
        border: none;  
        cursor: pointer;  
        font-size: 18px;
        color: #666;
        padding: 4px;
        border-radius: 4px;
        transition: all 0.2s ease;
        margin-left: 5px;
    }  

    .close-btn:hover {
        background: rgba(0, 0, 0, 0.05);
        color: #333;
    }  

    /* Tooltip Styles */
    .tooltip {  
        position: fixed;  
        background: rgba(255, 255, 255, 0.95);
        border-radius: 4px;  
        padding: 6px 10px;  
        font-size: 11px;
        display: none;  
        z-index: 1001;  
        pointer-events: none;  
        border: 1px solid rgba(0, 0, 0, 0.1);
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        backdrop-filter: blur(5px);
    }  

    /* Search Suggestions Styles */
    .suggestions {  
        position: fixed;  
        top: 50px;  
        right: 20px;  
        background: rgba(255, 255, 255, 0.9);
        border: 0.1px solid rgba(0, 0, 0, 0.1);
        z-index: 1001;  
        max-height: 200px;  
        overflow-y: auto;
        width: 300px;  
        display: none;  
        font-size: 10px;
    }  

    .suggestion-item {  
        padding: 10px;  
        cursor: pointer;  
        border-bottom: 1px solid #ccc;  
    }  

    .suggestion-item:hover {  
        background: #f0f0f0;   
    }  

    /* Sidebar Styles */
    #sidebar {  
        position: absolute;  
        top: 0;  
        left: 0;  
        width: 280px;
        height: 100%;  
        background-color: rgba(255, 255, 255, 0.45);
        padding: 4px 20px 0;
        box-shadow: 1px 0 8px rgba(0, 0, 0, 0.08);
        overflow-y: auto;
        overflow-x: hidden;
        border-right: 1px solid rgba(0, 0, 0, 0.05);
        font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
    }  

    /* Progress Navigation Styles */
    #progress-container {  
        display: flex;  
        justify-content: center;
        align-items: center;
        margin: 0;
        padding: 6px 0;
        position: sticky;
        top: 4px;
        z-index: 2000;
        background: none;
    }  

    .dot {  
        width: 8px;   
        height: 8px;   
        border-radius: 50%;   
        background-color: rgba(0, 0, 0, 0.1);
        margin: 0 4px;
        cursor: pointer;
        transition: all 0.3s ease;
        border: 1px solid transparent;
    }  

    .dot:hover {
        background-color: rgba(82, 167, 255, 0.5);
        transform: scale(1.1);
    }  

    .dot.active {  
        background-color: #52a7ff;
        border-color: #ffffff;
        box-shadow: 0 0 0 1px rgba(82, 167, 255, 0.3);
        transform: scale(1.1);
    }  

    /* Navigation Button Styles */
    #next-button {  
        width: 100%;  
        padding: 10px;  
        background-color: #246ab4;
        color: white; 
        border: none;  
        border-radius: 5px;
        cursor: pointer;
        font-weight: 600;
        letter-spacing: 0.05em;
        text-transform: uppercase;
        font-size: 0.85em;
        transition: all 0.3s ease;
        margin-top: 15px;
        box-shadow: 0 2px 4px rgba(36, 106, 180, 0.15);
        font-family: 'Roobert', 'SF Pro Display', -apple-system, sans-serif;
    }  

    #next-button:hover {  
        background-color: #3480d1;
        transform: translateY(-1px);
        box-shadow: 0 3px 8px rgba(36, 106, 180, 0.2);
    }  

    /* Content Section Styles */
    .sidebar-content {
        opacity: 0;
        transition: all 0.5s cubic-bezier(0.4, 0, 0.2, 1);
        display: none;
        padding: 12px;
        background: rgba(255, 255, 255, 0.55);
        border-radius: 6px;
        margin: 8px 0;
        position: relative;
        z-index: 1;
        transform: translateY(10px);
    }

    .sidebar-content.active {
        opacity: 1;
        display: block;
        transform: translateY(0);
    }

    /* Typography Styles */
    .sidebar-title {
        font-family: 'Georgia', 'Times New Roman', serif;
        font-size: 1.1em;
        font-weight: 700;
        margin-bottom: 12px;
        color: #000000;
        line-height: 1.3;
        letter-spacing: -0.01em;
        text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.05);
        position: relative;
        padding-bottom: 10px;
    }

    .sidebar-title::after {
        content: '';
        position: absolute;
        bottom: 0;
        left: 0;
        width: 60px;
        height: 3px;
        background: linear-gradient(90deg, #246ab4, #52a7ff);
        border-radius: 2px;
    }

    /* Chart Container Styles */
    .chart-container {
        position: relative;
        width: 100%;
        height: 420px;
        margin: 10px 0;
        background: rgba(255, 255, 255, 0.8);
        border-radius: 8px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    }

    /* Watermark Styles */
    .watermark {
        font-family: 'Open Sans', 'Arial Unicode MS Bold', sans-serif;
        font-size: 11px;
        color: rgba(255, 255, 255, 0.8);
        position: fixed;
        bottom: 15px;
        left: 100px;
        padding: 0;
        font-style: normal;
        font-weight: 500;
        letter-spacing: 0.15px;
        z-index: 1000;
        text-shadow: none;
    }

    .watermark:hover {
        color: rgba(255, 255, 255, 0.95);
    }
    </style>  
</head>  
<body>  
    <!-- Search Container -->
    <div id="searchContainer">  
        <div style="position: relative;">  
            <input type="text" id="searchBar" placeholder="Search Schools..." />  
            <button id="searchButton">  
                <img src="https://img.icons8.com/material-outlined/24/000000/search.png" alt="Search" />  
            </button>  
        </div>  
    </div>  
    
    <!-- Search Suggestions -->
    <div class="suggestions" id="suggestions"></div>  
    
    <!-- Map Container -->
    <div id="comparison-container">  
        <div id="map2020" class="map"></div>  
        <div id="map2021" class="map"></div>  
    </div>  
    
    <!-- Info Box -->
    <div class="info-box" id="infoBox">  
        <div id="infoContent"></div>  
        <canvas id="countryChart"></canvas>  
    </div>  
    
    <!-- Tooltip -->
    <div class="tooltip" id="tooltip"></div>
    
    <!-- Sidebar -->
    <div id="sidebar">  
        <!-- Navigation Dots -->
        <div id="progress-container">  
            <div class="dot active" id="dot-1" data-zoom="level1" onclick="navigateToView('level1')"></div>  
            <div class="dot" id="dot-2" data-zoom="level2" onclick="navigateToView('level2')"></div>  
            <div class="dot" id="dot-3" data-zoom="level3" onclick="navigateToView('level3')"></div>  
        </div>  
        
        <!-- Content Section 1: Introduction -->
        <div class="sidebar-content active" id="content-1">
            <h2 class="sidebar-title">Navigating New Horizons: The Impact of Brexit on International Student Enrollment in UK Education</h2>
            <img src="./plots/Header_Brexits-Impact-on-UK-Universities-Comprehensive-Analysis.jpg" alt="Brexit Impact Header" class="sidebar-image">
            <div class="image-attribution">
                Image source: <a href="https://amberstudent.com/news/post/brexits-impact-on-students-and-uk-universities-a-comprehensive-analysis" target="_blank">Amber Student</a>
            </div>
            <p class="sidebar-text">
                Embark on an engaging exploration of the <strong>profound effects</strong> Brexit has had on the dynamics of international education in the UK. This interactive map invites you to delve into the nuanced shifts in student demographics from both <strong>EU</strong> and <strong>non-EU</strong> countries before and after the referendum.
            </p>
            <div class="sidebar-tip">Click 'Next' to explore the impact of Brexit on UK educational trends!</div>
            <div class="sidebar-tip">Tap the map to see the composition of international students in detail!</div>
        </div>
        
        <!-- Content Section 2: Trends -->
        <div class="sidebar-content" id="content-2">
            <h2 class="sidebar-title">International Student Trends Post-Brexit (2006-2023)</h2>
            <p class="sidebar-text">
                From 2006 to 2020, EU student numbers held steady at <strong style="color: #246ab4">65,000</strong> âžœ post-Brexit policies triggered a sharp decline to <strong style="color: #246ab4">31,000</strong>, while enrollment from <strong style="color: #246ab4">China</strong> and <strong style="color: #246ab4">India</strong> showed sustained growth. Explore these shifting patterns by selecting different regions in the chart below.
            </p>
            <div class="chart-container" id="trendChart">
                <canvas id="lineChart"></canvas>
            </div>
        </div>
        
        <!-- Content Section 3: Regional Distribution -->
        <div class="sidebar-content" id="content-3">
            <h2 class="sidebar-title">Regional and European Student Distribution</h2>
            <p class="sidebar-text">
                As we zoom in closer, a clear shift emerges in the global student landscape. Asian countries now contribute <strong style="color: #246ab4">60%</strong> of international students, with notable increases from <strong style="color: #246ab4">South</strong> and <strong style="color: #246ab4">East Asia</strong>. Switch between the regional view and European countries to discover how different areas have adapted to the post-Brexit environment.
            </p>
            <div style="margin: 15px 0;">
                <select id="regionSelector">
                    <option value="regions">Regions Comparison</option>
                    <option value="european_countries">European Countries</option>
                </select>
            </div>
            <div class="chart-container" style="height: 300px; margin-bottom: 10px;">
                <canvas id="cityComparisonChart"></canvas>
            </div>
            <div class="chart-legend">
                * Comparing academic years 2020/2021 and 2021/2022
            </div>
            <div class="sidebar-tip">
                Use the search function or click on locations to view detailed trends for each institution
            </div>
        </div>  
        
        <!-- Navigation Button -->
        <button id="next-button">Next</button>  
    </div>  
    
    <!-- Watermark -->
    <div class="watermark">Created by @Yixing</div>

    <script>
    // Mapbox Configuration and Map Initialization
    mapboxgl.accessToken = 'pk.eyJ1IjoieWl4aW5nLWxpIiwiYSI6ImNtN3FtNWh6YjA0ancybnM4aGxjZnlheTEifQ.sKwaoIMQR65VQmYDbnu2MQ';  
    
    // Initialize the maps for both years
    const map2020 = new mapboxgl.Map({  
        container: 'map2020',  
        style: 'mapbox://styles/yixing-li/cm7qq3q0q00le01sb6zwp03g9',  
        center: [-1, 40],  
        zoom: 3,  
        pitch: 0,  
        bearing: 0  
    });  
    
    const map2021 = new mapboxgl.Map({  
        container: 'map2021',  
        style: 'mapbox://styles/yixing-li/cm7qq3q0q00le01sb6zwp03g9',  
        center: [-1, 40],  
        zoom: 3,  
        pitch: 0,  
        bearing: 0  
    });  
    
    // Initialize map comparison
    new mapboxgl.Compare(map2020, map2021, '#comparison-container', {  
        orientation: 'vertical'  
    });  

    // Data Processing Functions
    const processMapData = (map, geojsonUrl, heatmapColor, pointColor, yearLabel) => {  
        map.on('load', () => {  
            // Load school data
            fetch(geojsonUrl)  
                .then(response => response.json())  
                .then(data => {  
                    const filteredFeatures = data.features.filter(f => f.geometry?.type === "Point" && f.properties?.students > 0);  
                    const filteredData = { type: 'FeatureCollection', features: filteredFeatures };  

                    // Load country centroids and initialize visualization
                    loadCountryCentroids(map, filteredFeatures);  
                    addHeatmapLayer(map, filteredData, heatmapColor);  
                    addSchoolsPointLayer(map, filteredData, pointColor);  
                    setupMapInteractions(map, filteredFeatures, yearLabel);  
                })  
                .catch(error => console.error("Error loading school data:", error));  
        });  
    };  

    // Format country names for display
    const formatMapCountryName = (name) => {
        return name
            .replace(/\([^)]*\)/g, '')  // Remove parentheses and their content
            .trim()
            .replace(/_/g, ' ')  // Replace underscores with spaces
            .split(' ')
            .map(word => word.charAt(0).toUpperCase() + word.slice(1).toLowerCase())
            .join(' ');
    };

    // Load and process country centroids
    const loadCountryCentroids = (map, allFeatures) => {  
        fetch('./countries_centroids.geojson')  
            .then(response => response.json())  
            .then(data => {  
                // Format country names
                data.features.forEach(feature => {
                    feature.properties.country = formatMapCountryName(feature.properties.country);
                });

                const countryCentroids = {};  
                data.features.forEach(feature => {  
                    const country = feature.properties.country;  
                    countryCentroids[country] = feature;  
                });  

                // Initialize flow lines and country markers
                drawFlowLines(map, countryCentroids, allFeatures);  
                addCountryMarkers(map, data);
            })  
            .catch(error => console.error("Error loading centroids data:", error));  
    };  

    // Add country markers and labels to the map
    const addCountryMarkers = (map, data) => {
        // Add centroids source
        map.addSource('countries-centroids', {  
            type: 'geojson',  
            data: data  
        });  

        // Add centroid points
        map.addLayer({  
            id: 'country-centroids-layer',  
            type: 'circle',  
            source: 'countries-centroids',  
            paint: {  
                'circle-radius': 3,  
                'circle-color': '#000000',  
                'circle-opacity': 0.6  
            }  
        });  

        // Add country labels
        map.addLayer({  
            id: 'country-labels-layer',  
            type: 'symbol',  
            source: 'countries-centroids',  
            layout: {  
                'text-field': [
                    'format',
                    ['to-string', ['get', 'country']],
                    {
                        'text-transform': 'lowercase',
                        'font-scale': 1
                    }
                ],
                'text-font': ['Open Sans Bold', 'Arial Unicode MS Bold'],  
                'text-size': 12,  
                'text-allow-overlap': true  
            },  
            paint: {  
                'text-color': '#FFFFFF'  
            }  
        });  
    };

    // Draw flow lines between schools and countries
    const drawFlowLines = (map, countryCentroids, allFeatures) => {  
        const studentsFlowData = { type: 'FeatureCollection', features: [] };  

        allFeatures.forEach(feature => {  
            const props = feature.properties;  
            const totalStudents = props.students;  
            const country = formatMapCountryName(props.country);  
            const centroidFeature = countryCentroids[country];  

            if (centroidFeature && totalStudents > 0) {  
                const startCoord = feature.geometry.coordinates;  
                const endCoord = centroidFeature.geometry.coordinates;  

                // Calculate curved line effect
                const midPoint = [  
                    (startCoord[0] + endCoord[0]) / 2,  
                    (startCoord[1] + endCoord[1]) / 2 + 0.8  // Increased curve height
                ];  

                const flowLine = {  
                    type: 'Feature',  
                    geometry: {  
                        type: 'LineString',  
                        coordinates: [startCoord, midPoint, endCoord]  
                    },  
                    properties: {   
                        weight: totalStudents,   
                        brexitStatus: props.year  
                    }  
                };  
                studentsFlowData.features.push(flowLine);  
            }  
        });  

        if (studentsFlowData.features.length > 0) {  
            addFlowLinesLayer(map, studentsFlowData);
        }  
    };  

    // Add flow lines layer to the map
    const addFlowLinesLayer = (map, studentsFlowData) => {
        map.addSource('flow-lines', {  
            type: 'geojson',  
            data: studentsFlowData  
        });  

        map.addLayer({  
            id: 'flow-lines-layer',  
            type: 'line',  
            source: 'flow-lines',  
            paint: {  
                'line-width': [  
                    'interpolate',  
                    ['linear'],  
                    ['get', 'weight'],  
                    0, 0.1,  
                    100, 0.3,  
                    500, 0.6,  
                    1000, 1.2,  
                    5000, 2,  
                    10000, 3  
                ],  
                'line-opacity': [  
                    'interpolate',  
                    ['linear'],  
                    ['get', 'weight'],  
                    0, 0.1,  
                    100, 0.3,  
                    500, 0.5,  
                    1000, 0.7  
                ],  
                'line-color': [  
                    'case',  
                    ['==', ['get', 'brexitStatus'], '2020/2021'], 'rgba(210, 210, 255, 0.45)',  // Pre-Brexit light blue
                    ['==', ['get', 'brexitStatus'], '2021/2022'], 'rgba(246, 200, 200, 0.45)',  // Post-Brexit light red
                    'rgba(255, 255, 255, 0.5)'  // Default color
                ]  
            }
        });  
    };

    // Add heatmap layer to visualize student density
    const addHeatmapLayer = (map, filteredData, heatmapColor) => {  
        map.addSource('schools-heatmap', {  
            type: 'geojson',  
            data: filteredData  
        });  
        
        map.addLayer({  
            id: 'schools-heatmap-layer',  
            type: 'heatmap',  
            source: 'schools-heatmap',  
            paint: {  
                'heatmap-weight': [  
                    'interpolate',  
                    ['linear'],  
                    ['get', 'students'],  
                    0, 0,  
                    100, 0.05,  
                    500, 0.1,  
                    1000, 0.2,  
                    5000, 0.4,  
                    8000, 0.5,  
                    10000, 0.6,  
                    11000, 0.7,  
                    13000, 0.85,  
                    15000, 1  
                ],  
                'heatmap-color': [  
                    'interpolate',  
                    ['linear'],  
                    ['heatmap-density'],  
                    0, 'rgba(255,255,255,0)',  
                    0.2, heatmapColor[0],  
                    0.4, heatmapColor[1],  
                    0.6, heatmapColor[2],  
                    0.8, heatmapColor[3]  
                ],  
                'heatmap-radius': [  
                    'interpolate',  
                    ['linear'],  
                    ['zoom'],  
                    0, 20,  
                    9, 30  
                ],  
                'heatmap-intensity': [  
                    'interpolate',  
                    ['linear'],  
                    ['zoom'],  
                    0, 0.6,  
                    9, 1.2  
                ]  
            }  
        });  
    };  

    // Add school points layer
    const addSchoolsPointLayer = (map, filteredData, pointColor) => {  
        map.addSource('schools-points', { type: 'geojson', data: filteredData });  
        map.addLayer({  
            id: 'schools-points-layer',  
            type: 'circle',  
            source: 'schools-points',  
            paint: {  
                'circle-radius': [  
                    'interpolate',  
                    ['linear'],  
                    ['get', 'students'],  
                    0, 0.2,  
                    100, 0.5,  
                    500, 1,  
                    800, 1.3,  
                    1000, 1.7,  
                    3000, 3,  
                    5000, 4,  
                    7000, 6,  
                    8000, 7,  
                    10000, 8,  
                    15000, 10,  
                    17000, 13  
                ],  
                'circle-color': pointColor,  
                'circle-opacity': 0.9,
                'circle-stroke-width': 0.5,  
                'circle-stroke-color': '#FFFFFF'  
            }  
        });  
    };  

    // Setup map interaction handlers
    const setupMapInteractions = (map, filteredFeatures, yearLabel) => {  
        // Click handler for school points
        map.on('click', 'schools-points-layer', (e) => {  
            const feature = e.features[0];  
            if (!feature) return;  

            const props = feature.properties;  
            const totalStudents = props.students;  
            const providerName = props.he_provider || "Unnamed School";  
            const countriesCount = getCountriesCount(filteredFeatures);  
            const countryLabels = Object.keys(countriesCount);  
            const countryData = Object.values(countriesCount);  

            // Set color based on year
            const color = yearLabel.includes('2020') ? '#2c81c0' : '#e26363';
            showPopup(providerName, yearLabel, totalStudents, countryLabels, countryData, color);  
        });  

        // Mouse hover effects
        map.on('mouseenter', 'schools-points-layer', (e) => {  
            map.getCanvas().style.cursor = 'pointer';  
            displayTooltip(e.point, "Click to view student composition");  
        });  

        map.on('mouseleave', 'schools-points-layer', () => {  
            map.getCanvas().style.cursor = '';  
            hideTooltip();  
        });  
    };  

    // Display tooltip
    const displayTooltip = (point, message) => {  
        const tooltip = document.getElementById('tooltip');  
        tooltip.style.display = 'block';  
        tooltip.innerHTML = message;  
        tooltip.style.left = `${point.x}px`;  
        tooltip.style.top = `${point.y}px`;  
    };  

    // Hide tooltip
    const hideTooltip = () => {  
        document.getElementById('tooltip').style.display = 'none';  
    };  

    // Get student count by country
    const getCountriesCount = (filteredFeatures) => {  
        const countriesCount = {};  
        filteredFeatures.forEach(f => {  
            let country = f.properties.country;  
            const students = f.properties.students;  
            if (country && 
                country.trim() !== "" && 
                !country.toLowerCase().includes("total") &&
                !country.toLowerCase().includes("specified")) {  
                country = formatMapCountryName(country);
                countriesCount[country] = (countriesCount[country] || 0) + students;  
            }  
        });  
        return countriesCount;  
    };   

    // Show popup with school information
    const showPopup = (providerName, yearLabel, totalStudents, countryLabels, countryData, color) => {  
        const popupHTML = `  
            <div class="info-header">
                <div class="info-title">${providerName}</div>
                <div class="info-controls">
                    <button class="brexit-toggle active" data-year="2020">2020/2021</button>
                    <button class="brexit-toggle" data-year="2021">2021/2022</button>
                    <button class="close-btn" onclick="document.getElementById('infoBox').style.display='none'">&times;</button>
                </div>
            </div>
            <div style="font-size: 11px; margin-bottom: 2px;">
                <div style="margin-bottom: 2px;">Selected Year: <strong class="year-label">${yearLabel}</strong></div>
                <div>Total International Students: <strong class="total-students">${totalStudents}</strong></div>
            </div>
            <div style="position: relative; height: 200px;">
                <canvas id="countryChart"></canvas>
            </div>  
        `;  

        document.getElementById('infoContent').innerHTML = popupHTML;  
        document.getElementById('infoBox').style.display = 'block';  

        // Setup Brexit toggle buttons
        setupBrexitToggle(providerName, countryLabels, countryData);

        // Initialize chart
        setTimeout(() => {
            updateChart(countryLabels, countryData, color);  
        }, 50);
    };  

    // Setup Brexit toggle functionality
    const setupBrexitToggle = (providerName, countryLabels, countryData) => {
        const toggleButtons = document.querySelectorAll('.brexit-toggle');
        toggleButtons.forEach(button => {
            button.addEventListener('click', () => {
                toggleButtons.forEach(btn => btn.classList.remove('active'));
                button.classList.add('active');
                
                const year = button.dataset.year;
                if (year === '2020') {
                    updateChart(countryLabels, countryData, '#2c81c0');
                    document.querySelector('.year-label').textContent = '2020/2021 (Pre-Brexit)';
                    updateStudentCount(map2020, providerName);
                } else {
                    updateStudentCount(map2021, providerName);
                    const data2021 = getCountriesCount(map2021.getSource('schools-points')._data.features);
                    updateChart(Object.keys(data2021), Object.values(data2021), '#e26363');
                    document.querySelector('.year-label').textContent = '2021/2022 (Post-Brexit)';
                }
            });
        });
    };

    // Update student count display
    const updateStudentCount = (map, providerName) => {
        const feature = map.querySourceFeatures('schools-points', {
            filter: ['==', ['get', 'he_provider'], providerName]
        })[0];
        if (feature) {
            document.querySelector('.total-students').textContent = feature.properties.students;
        }
    };

    // Update chart visualization
    const updateChart = (countryLabels, countryData, color) => {  
        const ctx = document.getElementById('countryChart');  
        if (Chart.getChart(ctx)) {  
            Chart.getChart(ctx).destroy();  
        }  

        new Chart(ctx, {  
            type: 'bar',  
            data: {  
                labels: countryLabels,  
                datasets: [{  
                    label: 'Students',  
                    data: countryData,  
                    backgroundColor: color,
                    borderColor: color,
                    borderWidth: 1,
                    barPercentage: 0.8,
                    categoryPercentage: 0.8
                }]  
            },  
            options: {  
                responsive: true,  
                maintainAspectRatio: false,  
                layout: {
                    padding: {
                        bottom: 5,
                        right: 8,
                        left: 5,
                        top: 5
                    }
                },
                scales: {  
                    x: {  
                        grid: {
                            display: false
                        },
                        ticks: {  
                            font: {
                                size: 8
                            },
                            maxRotation: 45,
                            minRotation: 45,
                            padding: 2
                        }  
                    },  
                    y: {  
                        beginAtZero: true,  
                        grid: {
                            color: 'rgba(0, 0, 0, 0.05)'
                        },
                        ticks: {  
                            color: '#333',  
                            font: { size: 9 },
                            padding: 2,
                            callback: function(value) {
                                return value.toLocaleString();
                            }
                        }  
                    }  
                },  
                plugins: {  
                    legend: { display: false },  
                    tooltip: {
                        backgroundColor: 'rgba(255, 255, 255, 0.95)',
                        titleColor: '#333',
                        titleFont: { size: 12, weight: 'bold' },
                        bodyColor: '#666',
                        bodyFont: { size: 11 },
                        borderColor: 'rgba(0, 0, 0, 0.1)',
                        borderWidth: 1,
                        padding: 8,
                        displayColors: false,
                        callbacks: {
                            label: function(context) {
                                return `Students: ${context.raw.toLocaleString()}`;
                            }
                        }
                    }
                }  
            }  
        });  
    };  

    // Navigation functionality
    const dots = document.querySelectorAll('.dot');  
    let currentIndex = 0;
    
    const views = {
        level1: {
            center: [-1, 40],
            zoom: 3.5
        },
        level2: {
            center: [-2.2, 53],
            zoom: 4.5
        },
        level3: {
            center: [-2.2, 53],
            zoom: 8
        }
    };  

    // Navigate to specific view
    function navigateToView(view) {  
        currentIndex = view === 'level1' ? 0 : view === 'level2' ? 1 : 2;
        updateDots();  
        handleMapZoom();
        updateSidebarContent(currentIndex);
    }  

    // Update navigation dots
    function updateDots() {  
        dots.forEach((dot, index) => {  
            dot.classList.toggle('active', index === currentIndex);
        });  
    }  

    // Handle map zoom levels
    function handleMapZoom() {  
        const viewLevels = ['level1', 'level2', 'level3'];
        const currentView = views[viewLevels[currentIndex]];
        
        [map2020, map2021].forEach(map => {
            map.flyTo({  
                center: currentView.center,  
                zoom: currentView.zoom,  
                speed: 1,  
                curve: 1,  
                easing(t) { return t; }  
            });  
        });
    }  

    // Initialize event listeners
    document.getElementById('next-button').addEventListener('click', function() {  
        currentIndex = (currentIndex + 1) % 3;
        updateDots();
        handleMapZoom();
        updateSidebarContent(currentIndex);
    });  

    dots.forEach(dot => {  
        dot.addEventListener('click', () => {  
            navigateToView(dot.getAttribute('data-zoom'));
        });  
    });  

    // Initialize maps with data
    processMapData(map2020, './geojson_outputs_schools_2020_2021.geojson', [  
        'rgba(200,200,255,0.5)',  
        'rgba(150, 173, 255, 0.72)',  
        'rgba(111, 133, 231, 0.85)',  
        'rgb(87, 95, 221)'  
    ], '#FFFFFF', '2020/2021 (Pre-Brexit)');  

    processMapData(map2021, './geojson_outputs_schools_2021_2022.geojson', [  
        'rgba(255,200,200,0.5)',  
        'rgba(255,150,150,0.7)',  
        'rgba(255, 114, 114, 0.9)',  
        'rgb(247, 77, 77)'  
    ], '#FFFFFF', '2021/2022 (Post-Brexit)');  

    </script>  
</body>  
</html>  