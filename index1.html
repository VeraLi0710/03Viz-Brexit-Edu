<!DOCTYPE html>  
<html lang="en">  
<head>  
  <meta charset="utf-8">  
  <title>2020 Schools Data Visualization - Fine Hex & Popup</title>  
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">  

  <!-- Mapbox GL JS -->  
  <script src="https://api.tiles.mapbox.com/mapbox-gl-js/v3.4.0/mapbox-gl.js"></script>  
  <link href="https://api.tiles.mapbox.com/mapbox-gl-js/v3.4.0/mapbox-gl.css" rel="stylesheet">  

  <!-- Turf.js -->  
  <script src="https://unpkg.com/@turf/turf@6/turf.min.js"></script>  

  <!-- Chart.js -->  
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>  

  <style>  
    body { margin: 0; padding: 0; }  
    #map { position: absolute; top: 0; bottom: 0; width: 100%; }  

    .mapboxgl-popup-content {  
      background: rgba(255, 255, 255, 0.9) !important;  
      box-shadow: none !important;  
      border: none !important;  
      border-radius: 10px !important;  /* 修改默认弹窗圆角 */  
    }  
    .mapboxgl-popup {  
      background: transparent !important;  
      border: none !important;  
    }  
    .mapboxgl-popup-tip {  
      background: transparent !important;  
      border: none !important;  
    }
  </style>
</head>  
<body>  

<div id="map"></div>  

<script>  
  // 你的 Mapbox token  
  mapboxgl.accessToken = 'pk.eyJ1IjoieWl4aW5nLWxpIiwiYSI6ImNtN3FtNWh6YjA0ancybnM4aGxjZnlheTEifQ.sKwaoIMQR65VQmYDbnu2MQ';  

  // 初始化地图  
  const map = new mapboxgl.Map({  
    container: 'map',  
    style: 'mapbox://styles/yixing-li/cm7qq3q0q00le01sb6zwp03g9', // 替换为你的样式  
    center: [0, 51.5],  
    zoom: 5,  
    pitch: 45,  
    bearing: 0  
  });  

  map.on('load', () => {  
    // 加载你的学校点数据  
    fetch('./geojson_outputs_schools_2020_2021.geojson') // 根据你自己的路径  
      .then(response => response.json())  
      .then(data => {  
        console.log("原始 GeoJSON Data:", data);  

        // 过滤只保留 Point 且 students>0  
        const filteredFeatures = data.features.filter(f =>  
          f.geometry?.type === "Point" && f.properties?.students > 0  
        );  

        const filteredData = {  
          type: 'FeatureCollection',  
          features: filteredFeatures  
        };  
        console.log("过滤后点数:", filteredData.features.length);  

        // 求 bbox，用于生成 hex  
        const bbox = turf.bbox(filteredData);  

        // 生成更细的六边形网格  
        const cellSizeKm = 3;  // 这里可以再加大或减小以控制六边形密度  
        let hexGrid = turf.hexGrid(bbox, cellSizeKm, { units: 'kilometers' });  
        console.log("初始Hex网格数:", hexGrid.features.length);  

        // 遍历 hex，每个 hex 内累加信息  
        hexGrid.features.forEach((hex) => {  
          let sumStudents = 0;  
          let countries = {};  

          // 收集多所大学  
          let providerSet = new Set();  

          filteredData.features.forEach(pt => {  
            if (turf.booleanPointInPolygon(pt, hex)) {  
              sumStudents += pt.properties.students;  

              // 累加到 countries  
              const c = pt.properties.country || 'unknown';  
              countries[c] = (countries[c] || 0) + pt.properties.students;  

              // 大学名称  
              const provider = pt.properties.he_provider || "Unnamed School";  
              providerSet.add(provider);  
            }  
          });  

          // 将大学名称数组做一个符号拼接  
          const providerNameStr = Array.from(providerSet)  
            .map(name => "• " + name) // 每行前面加"• "  
            .join("<br/>");  

          hex.properties = {  
            sum_students: sumStudents,  
            countries: countries,  
            he_provider: providerNameStr  
          };  
        });  

        // 过滤掉没学生的 hex  
        hexGrid.features = hexGrid.features.filter(f => f.properties.sum_students > 0);  
        console.log("有学生的Hex网格数:", hexGrid.features.length);  

        // 添加 Source  
        map.addSource('schools-hex', {  
          type: 'geojson',  
          data: hexGrid  
        });  

        // 3D填充层  
        map.addLayer({  
          id: 'hex-extrusion',  
          type: 'fill-extrusion',  
          source: 'schools-hex',  
          paint: {  
            // 高度随 zoom 变化  
            'fill-extrusion-height': [  
              'interpolate', ['linear'], ['zoom'],  
              5, ['*', ['get', 'sum_students'], 10],  
              10, ['*', ['get', 'sum_students'], 20],  
              15, ['*', ['get', 'sum_students'], 50]  
            ],  
            // 颜色随 sum_students 变化  
            'fill-extrusion-color': [  
              'interpolate', ['linear'], ['get', 'sum_students'],  
              0, '#fff',  
              1000, '#d2f2ff',  
              3000, '#c4eeff',  
              5000, '#a8e5ff',  
              7000, '#7fcbff',  
              10000, '#67abff',  
              15000, '#499bff'  
            ],  
            'fill-extrusion-opacity': 0.8  
          }  
        });  

        // 缩放到所有 hex 范围  
        const bounds = new mapboxgl.LngLatBounds();  
        hexGrid.features.forEach(f => {  
          f.geometry.coordinates[0].forEach(coord => {  
            bounds.extend(coord);  
          });  
        });  
        map.fitBounds(bounds, { padding: 50 });  

        // =========== Popup & Chart 逻辑 ===========  

        // 创建弹窗，并设定一个更大的 maxWidth  
        let popup = new mapboxgl.Popup({  
          closeButton: true,  
          closeOnClick: false  
        }).setMaxWidth("800px"); // 可以改成 "none" 或者 "1000px" 等  

        // 鼠标悬浮事件  
        map.on('mousemove', 'hex-extrusion', (e) => {  
          map.getCanvas().style.cursor = 'pointer';  

          const feature = e.features[0];  
          if (!feature) return;  

          const props = feature.properties;  
          const totalStudents = props.sum_students;  
          const providerName = props.he_provider || "Unnamed School";  

          // 解析 countries  
          let countriesObj;  
          try {  
            countriesObj = JSON.parse(props.countries); // 有时存的是字符串  
          } catch (err) {  
            countriesObj = props.countries || {};  
          }  

          // 删掉 "total"（如有）  
          if (countriesObj.hasOwnProperty("total")) {  
            delete countriesObj.total;  
          }  

          // 组装 Chart.js 的 labels & data  
          let countryLabels = [];  
          let countryData = [];  
          for (let c in countriesObj) {  
            if (!countriesObj.hasOwnProperty(c)) continue;  
            let upperKey = c.charAt(0).toUpperCase() + c.slice(1);  
            countryLabels.push(upperKey);  
            countryData.push(countriesObj[c]);  
          }  

          // 弹窗 HTML  
          const popupHTML = `  
            <div style="  
              background: rgba(255,255,255,0.9);     /* 背景微透明 */  
              padding: 14px;  
              max-height: 300px;  
              font-family: Arial, sans-serif;  
              border-radius: 10px;                   /* 增加圆角 */  
              box-shadow: 0 1px 6px rgba(0, 0, 0, 0.15); /* 添加柔和阴影 */  
              border: 0.2px solid rgba(0, 0, 0, 0.1);  /* 细边框 */  
              color: #333;  
              font-size: 14px;  
              overflow-y: auto;  
              overflow-x: hidden;  
            ">  
              <div style="font-size:16px; font-weight:bold; margin-bottom:4px; line-height:2;">  
                ${providerName}  
              </div>  
              <div style="margin-bottom:8px;">  
                Total International Students: <strong>${totalStudents}</strong>  
              </div>  
              <canvas  
                id="countryChart"  
                style="border: 1px solid #ccc; display: block; width: 100%; height: auto;">  
              </canvas>  
            </div>  
          `;

          popup  
            .setLngLat(e.lngLat)  
            .setHTML(popupHTML)  
            .addTo(map);  

          // 由于 setHTML 后马上加载 Chart 可能找不到 canvas，故延时一点  
          setTimeout(() => {  
            const ctx = document.getElementById('countryChart');  
            if (!ctx) return;  

            new Chart(ctx, {  
              type: 'bar',  
              data: {  
                labels: countryLabels,  
                datasets: [{  
                  label: 'Students',  
                  data: countryData,  
                  backgroundColor: '#2c81c0',  
                  barPercentage: 0.6,  
                  categoryPercentage: 0.6  
                }]  
              },  
              options: {  
                responsive: true,           // 开启自适应  
                maintainAspectRatio: false, // 图表可随div大小拉伸  
                scales: {  
                  x: {  
                    ticks: {  
                      color: '#333',  
                      font: { size: 10 }  
                    }  
                  },  
                  y: {  
                    beginAtZero: true,  
                    ticks: {  
                      color: '#333',  
                      font: { size: 10 }  
                    }  
                  }  
                },  
                plugins: {  
                  legend: { display: false },  
                  title: { display: false }  
                }  
              }  
            });  
          }, 50);  
        });  

        // 鼠标离开时，仅重置样式，不强制关 popup  
        map.on('mouseleave', 'hex-extrusion', () => {  
          map.getCanvas().style.cursor = '';  
        });  
      })  
      .catch(error => console.error("加载或处理 GeoJSON 时出错:", error));  
  });  
</script>  

</body>  
</html>